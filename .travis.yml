sudo: required
dist: trusty
language: C
services:
  - docker
env:
  - PG_SUPPORTED_VERSIONS=9.3 DIST=trusty
  - PG_SUPPORTED_VERSIONS=9.4 DIST=trusty
  - PG_SUPPORTED_VERSIONS=9.5 DIST=trusty
  - PG_SUPPORTED_VERSIONS=9.6 DIST=trusty
  - PG_SUPPORTED_VERSIONS=10  DIST=trusty
  - PG_SUPPORTED_VERSIONS=11  DIST=trusty
  - PG_SUPPORTED_VERSIONS=12  DIST=trusty
  - PG_SUPPORTED_VERSIONS=9.3 DIST=xenial
  - PG_SUPPORTED_VERSIONS=9.4 DIST=xenial
  - PG_SUPPORTED_VERSIONS=9.5 DIST=xenial
  - PG_SUPPORTED_VERSIONS=9.6 DIST=xenial
  - PG_SUPPORTED_VERSIONS=10  DIST=xenial
  - PG_SUPPORTED_VERSIONS=11  DIST=xenial
  - PG_SUPPORTED_VERSIONS=12  DIST=xenial
before_install:
  - docker pull heroku/dod-package-dev:$DIST
  - mkdir -p ../deb-build ../packages/$DIST
  - |
    cat <<'EOF' > ../deb-build/build.sh
    #!/bin/sh -x

    export DEBIAN_FRONTEND=noninteractive

    wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -
    case $PG_SUPPORTED_VERSIONS in
      11|12)
      # update pgdg-source.list
      sed -i -e "s/pgdg.*/pgdg-testing main $PG_SUPPORTED_VERSIONS/" /etc/apt/sources.list.d/pgdg*.list
      export DIST=$DIST-pgdg-testing
      ;;
      *)
      export DIST=$DIST-pgdg
      ;;
    esac

    apt-get update -y
    apt-get install -y -t $DIST debhelper fakeroot postgresql-common postgresql-server-dev-all postgresql-server-dev-$PG_SUPPORTED_VERSIONS

    if [ ! -x /usr/lib/postgresql/$PG_SUPPORTED_VERSIONS/bin/postgres ]; then
      sudo /etc/init.d/postgresql stop # stop postgresql again before installing the server
      apt-get install -y postgresql-$PG_SUPPORTED_VERSIONS
    fi

    /etc/init.d/postgresql stop
    pg_lsclusters
    dpkg -l postgresql\* | cat

    cd /root/build/pgextwlist

    pg_buildext updatecontrol
    dpkg-buildpackage -us -uc -rfakeroot
    for deb in ../*.deb; do echo "$deb:"; dpkg-deb --info $deb; dpkg-deb --contents $deb; done
    sudo dpkg -i ../*.deb
    pg_buildext -i '--locale=C.UTF-8' -o local_preload_libraries=pgextwlist -o extwlist.extensions=citext,earthdistance,pg_trgm installcheck

  - chmod 755 ../deb-build/build.sh
script:
  - |
    docker run -v $(readlink -f ../deb-build):/root/deb-build \
               -v $(readlink -f ../packages/$DIST):/root/build \
               -v $(readlink -f .):/root/build/pgextwlist \
               -e DIST=$DIST -e PG_SUPPORTED_VERSIONS=$PG_SUPPORTED_VERSIONS \
               --privileged=true -it heroku/dod-package-dev:$DIST \
               bash -x /root/deb-build/build.sh
  - du -a ../packages/$DIST
notifications:
  email: false
